#!/usr/bin/env perl6
#

use Test;
use JSON::Fast;
use Pakku::Dist::Perl6;

my $dist-meta = q:to/END/;
  {
  "build-depends" : [ ],
  "depends": {
    "runtime": {
      "requires": [
        "Sereal:auth<cpan:*>:ver(1..*)",
        "curl:from<bin>",
        [ "Archive::Compress", "Archive::Zlib" ],
        {
          "from" : "bin",
          "name" : {
            "by-distro.name" : {
              "macosx" : "python2.7-config",
              "debian" : "python2.7-config",
              "" : "python2-config"
            }
          }
        },
        {
          "name": "archive:from<native>",
          "hints": {
            "by-kernel.name": {
              "win32": {
                "url": "http://www.p6c.org/~jnthn/libarchive/libarchive.dll",
                "checksum": {"sha-256": "E6836E32802555593AEDAFE1CC00752CBDA"},
                "target": "resources/libraries/"
              }
            }
          }
        },
        "JSON::Fast"
      ],
      "recommends": [
        "JSON::Pretty"
      ]
    },
    "build": {
      "requires": [
        "System::Info"
      ]
    },
    "test": {
      "requires": [
        "File::Temp"
      ]
    }
  }
}
END

my %expected = %(${:build(${:requires($["System::Info"])}), :runtime(${:recommends($["JSON::Pretty"]), :requires($["Sereal:ver<1.*>:auth<cpan:*>", "curl", ["Archive::Compress", "Archive::Zlib"], "python2-config", "archive", "JSON::Fast"])}), :test(${:requires($["File::Temp"])})});

my $meta = from-json $dist-meta;
my $dist  = Pakku::Dist::Perl6.new: :$meta;

my %got =  $dist.depends.deepmap( *.Str );

is-deeply %got, %expected;

